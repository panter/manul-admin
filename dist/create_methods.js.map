{"version":3,"sources":["../src/create_methods.js"],"names":["DEBUG","context","config","Meteor","ValidatedMethod","SimpleSchema","require","default","error","Error","ListSchema","filter","type","Object","optional","blackbox","searchTerm","String","sortProperties","Array","pageProperties","extendSimpleSchema","schema","otherSchema","version","extend","isAllowed","createFor","collections","collectionName","collection","allowInsertWithId","searchFields","transformFilter","getListQueryAndOptions","query","queryOptions","console","log","update","name","validate","simpleSchema","_id","validator","clean","run","doc","isServer","userId","updated","$set","bypassCollection2","create","insert","destroy","remove","list","options","docs","find","fetch","count","listCount","methods","forEach"],"mappings":"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","file":"create_methods.js","sourcesContent":["import { filterToQuery, gridOptionsToQueryOptions } from './utils/query_utils';\nimport IsAllowed from './is_allowed';\n\nconst DEBUG = false;\n\nexport default (context, config) => {\n  const { Meteor, ValidatedMethod } = context;\n  let SimpleSchema;\n  try {\n    /* eslint global-require: 0 */\n    SimpleSchema = require('simpl-schema').default;\n  } catch (error) {\n    // try to get from context\n    SimpleSchema = context.SimpleSchema;\n  }\n  if (!SimpleSchema) {\n    throw new Error(\n      'please provide SimpleSchema by npm or in context (version 1)'\n    );\n  }\n  const ListSchema = new SimpleSchema({\n    filter: {\n      type: Object,\n      optional: true,\n      blackbox: true\n    },\n    searchTerm: {\n      type: String,\n      optional: true\n    },\n    sortProperties: {\n      type: Array,\n      optional: true\n    },\n    'sortProperties.$': {\n      type: Object,\n      optional: true,\n      blackbox: true\n    },\n    pageProperties: {\n      type: Object,\n      optional: true,\n      blackbox: true\n    }\n  });\n  const extendSimpleSchema = (schema, otherSchema) => {\n    if (SimpleSchema.version === 2) {\n      return schema.extend(otherSchema);\n    }\n    return new SimpleSchema([schema, otherSchema]);\n  };\n  const isAllowed = IsAllowed(config);\n\n  const createFor = collectionName => {\n    const {\n      collection,\n      allowInsertWithId,\n      searchFields,\n      transformFilter\n    } = config.collections[collectionName];\n\n    const getListQueryAndOptions = ({\n      filter,\n      searchTerm = null,\n      sortProperties,\n      pageProperties\n    }) => {\n      const query = filterToQuery(\n        filter,\n        searchTerm && { searchFields, searchTerm },\n        transformFilter\n      );\n\n      const queryOptions = gridOptionsToQueryOptions({\n        sortProperties,\n        pageProperties\n      });\n      if (DEBUG) console.log(JSON.stringify({ query, queryOptions }));\n\n      return {\n        query,\n        queryOptions\n      };\n    };\n\n    return {\n      update: new ValidatedMethod({\n        name: `manulAdmin.${collectionName}.update`,\n        validate: extendSimpleSchema(collection.simpleSchema(), {\n          _id: { type: String }\n        }).validator({ clean: true }),\n        run({ _id, ...doc }) {\n          // console.log('updating', collectionName, _id, doc);\n          if (Meteor.isServer) {\n            if (!isAllowed(collectionName, this.userId)) {\n              throw new Meteor.Error('not allowed', 'You are not allowed');\n            }\n\n            // Whole-doc update is not supported by simpl-schema,\n            // as workaround we use bypassCollection2: true\n            // https://github.com/aldeed/meteor-simple-schema/issues/175\n            const updated = collection.update(\n              _id,\n              { $set: doc },\n              { bypassCollection2: true }\n            );\n            if (updated === 0) {\n              throw new Meteor.Error('not found', 'Entry not found');\n            }\n          }\n        }\n      }),\n      create: new ValidatedMethod({\n        name: `manulAdmin.${collectionName}.create`,\n        validate: (allowInsertWithId\n          ? extendSimpleSchema(collection.simpleSchema(), {\n              _id: { type: String, optional: true }\n            })\n          : collection.simpleSchema()\n        ).validator({ clean: true }),\n        run(doc) {\n          // console.log('inserting', doc);\n          if (!isAllowed(collectionName, this.userId)) {\n            throw new Meteor.Error('not allowed', 'You are not allowed');\n          }\n          return collection.insert(doc);\n        }\n      }),\n      destroy: new ValidatedMethod({\n        name: `manulAdmin.${collectionName}.destroy`,\n        validate: new SimpleSchema({ _id: { type: String } }).validator({\n          clean: true\n        }),\n        run({ _id }) {\n          // console.log('inserting', doc);\n          if (!isAllowed(collectionName, this.userId)) {\n            throw new Meteor.Error('not allowed', 'You are not allowed');\n          }\n          return collection.remove(_id);\n        }\n      }),\n      list: new ValidatedMethod({\n        name: `manulAdmin.${collectionName}.list`,\n        validate: ListSchema.validator({ clean: false }),\n        run(options) {\n          if (!isAllowed(collectionName, this.userId)) {\n            throw new Meteor.Error('not allowed', 'You are not allowed');\n          }\n          const { query, queryOptions } = getListQueryAndOptions(options);\n\n          return {\n            docs: collection.find(query, queryOptions).fetch(),\n            count: collection.find(query).count()\n          };\n        }\n      }),\n      listCount: new ValidatedMethod({\n        name: `manulAdmin.${collectionName}.listCount`,\n        validate: ListSchema.validator({ clean: false }),\n        run(options) {\n          if (!isAllowed(collectionName, this.userId)) {\n            throw new Meteor.Error('not allowed', 'You are not allowed');\n          }\n          const { query } = getListQueryAndOptions(options);\n          return collection.find(query).count();\n        }\n      })\n    };\n  };\n\n  const methods = {};\n  Object.keys(config.collections).forEach(collectionName => {\n    methods[collectionName] = createFor(collectionName);\n  });\n  return methods;\n};\n"]}